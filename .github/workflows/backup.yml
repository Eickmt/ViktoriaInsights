name: ğŸ›¡ï¸ ViktoriaInsights Datenbank-Backup

# Wann das Backup ausgefÃ¼hrt wird
on:
  schedule:
    # Jeden Tag um 02:00 Uhr (UTC) = 03:00/04:00 deutsche Zeit
    - cron: '0 2 * * *'
  
  # Manuell startbar Ã¼ber GitHub Interface
  workflow_dispatch:
    inputs:
      reason:
        description: 'Grund fÃ¼r manuelles Backup'
        required: false
        default: 'Manuelles Backup'

# Berechtigungen fÃ¼r den Workflow
permissions:
  contents: read
  actions: write

jobs:
  backup:
    name: ğŸ“Š Datenbank sichern
    runs-on: ubuntu-latest
    
    steps:
      # 1. Repository Code auschecken
      - name: ğŸ“¥ Code herunterladen
        uses: actions/checkout@v4
        
      # 2. Python-Umgebung einrichten
      - name: ğŸ Python 3.11 installieren
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      # 3. AbhÃ¤ngigkeiten installieren
      - name: ğŸ“¦ Python-Pakete installieren
        run: |
          python -m pip install --upgrade pip
          pip install supabase pandas openpyxl
          
      # 4. Backup-Script ausfÃ¼hren
      - name: ğŸ›¡ï¸ Datenbank-Backup erstellen
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸš€ Starte ViktoriaInsights Backup..."
          python backup_script.py
          echo "âœ… Backup-Script abgeschlossen"
          
      # 5. Backup-Dateien auflisten (fÃ¼r Debugging)
      - name: ğŸ“‹ Backup-Dateien auflisten
        run: |
          echo "ğŸ“ Erstellte Backup-Dateien:"
          ls -la backup_* 2>/dev/null || echo "âš ï¸ Keine Backup-Dateien gefunden"
          
      # 6. Backup-Dateien als Artifacts speichern
      - name: ğŸ’¾ Backup-Dateien speichern
        uses: actions/upload-artifact@v4
        with:
          name: viktoria-backup-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            backup_*.xlsx
            backup_*.md
          retention-days: 30  # 30 Tage aufbewahren
          compression-level: 6
          
      # 7. Backup-Statistiken anzeigen
      - name: ğŸ“Š Backup-Statistiken
        run: |
          echo "ğŸ“ˆ Backup-Zusammenfassung:"
          echo "ğŸ• Datum: $(date '+%d.%m.%Y %H:%M:%S')"
          echo "ğŸ”¢ Run-Nummer: ${{ github.run_number }}"
          echo "ğŸ“ Artifact-Name: viktoria-backup-${{ github.run_number }}-${{ github.run_attempt }}"
          
          # GrÃ¶ÃŸe der Backup-Dateien
          if ls backup_*.xlsx 1> /dev/null 2>&1; then
            echo "ğŸ’¾ Backup-GrÃ¶ÃŸen:"
            du -h backup_*.xlsx
          fi
          
      # 8. Benachrichtigung bei Erfolg
      - name: âœ… Erfolgs-Benachrichtigung
        if: success()
        run: |
          echo "ğŸ‰ ViktoriaInsights Backup erfolgreich abgeschlossen!"
          echo "ğŸ“¥ Download: GitHub â†’ Actions â†’ Artifacts"
          
      # 9. Benachrichtigung bei Fehler  
      - name: âŒ Fehler-Benachrichtigung
        if: failure()
        run: |
          echo "ğŸ’¥ ViktoriaInsights Backup fehlgeschlagen!"
          echo "ğŸ” Logs prÃ¼fen fÃ¼r Details"
          
  # Optional: Backup-Historie bereinigen (alte Artifacts lÃ¶schen)
  cleanup:
    name: ğŸ§¹ Alte Backups bereinigen
    runs-on: ubuntu-latest
    needs: backup
    if: always()
    
    steps:
      - name: ğŸ“¥ Code herunterladen
        uses: actions/checkout@v4
        
      - name: ğŸ§¹ Alte Artifacts lÃ¶schen (Ã¤lter als 30 Tage)
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let deletedCount = 0;
            
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name.startsWith('viktoria-backup-') && 
                  new Date(artifact.created_at) < thirtyDaysAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                  console.log(`ğŸ—‘ï¸ GelÃ¶scht: ${artifact.name}`);
                  deletedCount++;
                } catch (error) {
                  console.log(`âš ï¸ Fehler beim LÃ¶schen von ${artifact.name}:`, error.message);
                }
              }
            }
            
            console.log(`ğŸ§¹ ${deletedCount} alte Backup-Artifacts gelÃ¶scht`); 